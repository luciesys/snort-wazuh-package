---
- name: "ğŸ›¡ï¸ Installation SIEM (Snort + Wazuh)"
  hosts: siem_servers
  become: yes
  
  vars:
    wazuh_version: "4.7"
    min_ram_gb: 4
    min_disk_gb: 30

  tasks:
    - name: "ğŸ“‹ DÃ©but installation"
      debug:
        msg: "Installation SIEM sur {{ inventory_hostname }}"

    - name: "ğŸ” VÃ©rifier l'OS"
      assert:
        that:
          - ansible_distribution in ['Ubuntu', 'Debian']
        fail_msg: "OS non supportÃ©"

    - name: "ğŸ§¹ ArrÃªter anciens services"
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - wazuh-manager
        - wazuh-indexer
        - wazuh-dashboard
        - snort
      ignore_errors: yes

    - name: "ğŸ§¹ Supprimer anciens paquets"
      apt:
        name:
          - wazuh-manager
          - wazuh-indexer
          - wazuh-dashboard
          - snort
        state: absent
        purge: yes
      ignore_errors: yes

    - name: "ğŸ”„ Mise Ã  jour systÃ¨me"
      apt:
        update_cache: yes
        upgrade: dist

    - name: "ğŸ“¦ Installer dÃ©pendances"
      apt:
        name:
          - curl
          - wget
          - gnupg
          - apt-transport-https
          - net-tools
        state: present

    - name: "ğŸŒ Corriger DNS"
      copy:
        content: |
          nameserver 8.8.8.8
          nameserver 8.8.4.4
        dest: /etc/resolv.conf

    - name: "ğŸ” Installer Snort"
      apt:
        name: snort
        state: present
      ignore_errors: yes

    - name: "ğŸ” Configurer Snort"
      lineinfile:
        path: /etc/snort/snort.conf
        regexp: '^(ipvar|var) HOME_NET'
        line: "ipvar HOME_NET {{ ansible_default_ipv4.network }}/24"
      ignore_errors: yes

    - name: "ğŸ” CrÃ©er logs Snort"
      file:
        path: /var/log/snort
        state: directory
        mode: '0755'

    - name: "ğŸ“¥ TÃ©lÃ©charger Wazuh"
      get_url:
        url: "https://packages.wazuh.com/{{ wazuh_version }}/wazuh-install.sh"
        dest: /tmp/wazuh-install.sh
        mode: '0755'

    - name: "ğŸš€ Installer Wazuh (10-20 min)"
      command: bash /tmp/wazuh-install.sh -a -i
      args:
        creates: /var/ossec/bin/wazuh-control
      async: 1800
      poll: 30

    - name: "ğŸ”— IntÃ©grer Snort-Wazuh"
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: '</ossec_config>'
        block: |
          <localfile>
            <log_format>snort-full</log_format>
            <location>/var/log/snort/alert</location>
          </localfile>
      ignore_errors: yes

    - name: "âœ… TerminÃ©"
      debug:
        msg: |
          Installation terminÃ©e !
          Dashboard: https://{{ ansible_default_ipv4.address }}
          User: admin
