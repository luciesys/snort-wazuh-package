---
- name: "ğŸ“¦ Installation Agent Wazuh"
  hosts: wazuh_agents
  become: yes
  
  vars:
    wazuh_version: "4.7"
    manager_ip: "{{ wazuh_manager_ip }}"

  tasks:
    - name: "ğŸ“‹ DÃ©but installation agent"
      debug:
        msg: "Installation agent sur {{ inventory_hostname }} â†’ Manager: {{ manager_ip }}"

    - name: "ğŸ”„ Mise Ã  jour APT"
      apt:
        update_cache: yes

    - name: "ğŸ“¦ Installer dÃ©pendances"
      apt:
        name:
          - curl
          - gnupg
          - apt-transport-https
        state: present

    - name: "ğŸ“¥ Ajouter clÃ© GPG Wazuh"
      apt_key:
        url: https://packages.wazuh.com/key/GPG-KEY-WAZUH
        state: present

    - name: "ğŸ“¥ Ajouter dÃ©pÃ´t Wazuh"
      apt_repository:
        repo: "deb https://packages.wazuh.com/4.x/apt/ stable main"
        state: present
        filename: wazuh

    - name: "ğŸ“¦ Installer agent"
      apt:
        name: wazuh-agent
        state: present
      environment:
        WAZUH_MANAGER: "{{ manager_ip }}"

    - name: "âš™ï¸ Configurer Manager"
      lineinfile:
        path: /var/ossec/etc/ossec.conf
        regexp: '<address>.*</address>'
        line: "      <address>{{ manager_ip }}</address>"
        backrefs: yes

    - name: "ğŸš€ DÃ©marrer agent"
      systemd:
        name: wazuh-agent
        enabled: yes
        state: restarted

    - name: "âœ… TerminÃ©"
      debug:
        msg: "Agent installÃ© sur {{ inventory_hostname }}"
